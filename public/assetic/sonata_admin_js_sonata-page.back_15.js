(function(d,c){var b=function(f,g){var h=g||{};this.pageId=f;this.$container=d(".page-composer");this.$dynamicArea=d(".page-composer__dyn-content");this.$pagePreview=d(".page-composer__page-preview");this.$containerPreviews=this.$pagePreview.find(".page-composer__page-preview__container");this.routes=d.extend({},h.routes||{});this.translations=d.extend({},h.translations||{});this.csrfTokens=d.extend({},h.csrfTokens||{});this.bindPagePreviewHandlers();this.bindOrphansHandlers();var e=this,i=d(this);i.on("containerclick",function(j){e.loadContainer(j.$container)});i.on("containerloaded",this.handleContainerLoaded);i.on("blockcreated",this.handleBlockCreated);i.on("blockremoved",this.handleBlockRemoved);i.on("blockcreateformloaded",this.handleBlockCreateFormLoaded);i.on("blockpositionsupdate",this.handleBlockPositionsUpdate);i.on("blockeditformloaded",this.handleBlockEditFormLoaded);i.on("blockparentswitched",this.handleBlockParentSwitched)};function a(e){if(typeof c.admin!="undefined"){return}Admin.shared_setup(e)}b.prototype={translate:function(e){if(this.translations[e]){return this.translations[e]}return e},getRouteUrl:function(h,g){if(!this.routes[h]){throw new Error('Route "'+h+'" does not exist')}var f=this.routes[h];for(var e in g){f=f.replace(new RegExp(e),g[e])}return f},isFormControlTypeByName:function(f,h){if(typeof f!="undefined"){var e=f.length,g="["+h+"]",i=f.lastIndexOf(g),e=e-g.length;return i!==-1&&i===e}return false},handleBlockCreated:function(f){var e=this;d.ajax({url:this.getRouteUrl("block_preview",{BLOCK_ID:f.blockId}),type:"GET",success:function(i){var h=d(i);f.$childBlock.replaceWith(h);e.controlChildBlock(h);var g=e.getContainerChildCountFromList(f.parentId);if(g!==null){e.updateChildCount(f.parentId,g)}},error:function(){e.containerNotification("composer_preview_error","error",true)}})},handleBlockRemoved:function(f){var e=this.getContainerChildCountFromList(f.parentId);if(e!==null){this.updateChildCount(f.parentId,e)}},containerNotification:function(g,e,h){var i=this.$dynamicArea.find(".page-composer__container__view__notice");if(i.length===1){if(this.containerNotificationTimer){clearTimeout(this.containerNotificationTimer)}i.removeClass("persist success error");if(e){i.addClass(e)}i.text(this.translate(g));i.show();if(h!==true){this.containerNotificationTimer=setTimeout(function(){i.hide().empty()},2000)}else{var f=d('<span class="close-notice">x</span>');f.on("click",function(){i.hide().empty()});i.addClass("persist");i.append(f)}}},handleBlockPositionsUpdate:function(f){var e=this;this.containerNotification("composer_update_saving");d.ajax({url:this.getRouteUrl("save_blocks_positions"),type:"POST",data:{disposition:f.disposition},success:function(g){if(g.result&&g.result==="ok"){e.containerNotification("composer_update_saved","success")}},error:function(){e.containerNotification("composer_update_error","error",true)}})},handleBlockParentSwitched:function(i){var j=d(".block-preview-"+i.previousParentId),g=j.find(".child-count"),h=parseInt(g.text().trim(),10),f=d(".block-preview-"+i.newParentId),k=f.find(".child-count"),e=parseInt(k.text().trim(),10);this.updateChildCount(i.previousParentId,h-1);this.updateChildCount(i.newParentId,e+1)},getContainerChildCountFromList:function(e){var h=this.$dynamicArea.find(".block-view-"+e);if(h.length===0){return null}var g=h.find(".page-composer__container__child"),f=0;g.each(function(){var j=d(this),i=j.attr("data-block-id");if(typeof i!="undefined"){f++}});return f},updateChildCount:function(f,h){var g=d(".block-preview-"+f),e=d(".block-view-"+f);if(g.length>0){g.find(".child-count").text(h)}if(e.length>0){e.find(".page-composer__container__child-count span").text(h)}},handleBlockCreateFormLoaded:function(e){var p=this,f=this.$dynamicArea.find(".page-composer__container__children"),o=this.$dynamicArea.find(".page-composer__container__main-edition-area");if(e.container){var n=e.container,g=n.find(".page-composer__container__child__content");g.html(e.response)}else{var n=d(['<li class="page-composer__container__child">','<a class="page-composer__container__child__edit">','<h4 class="page-composer__container__child__name">','<input type="text" class="page-composer__container__child__name__input">',"</h4>","</a>",'<div class="page-composer__container__child__right">','<span class="badge">'+e.blockTypeLabel+"</span>","</div>",'<div class="page-composer__container__child__content">',"</div>","</li>"].join("")),g=n.find(".page-composer__container__child__content");g.append(e.response);f.append(n);g.show()}var r=n.find("form"),s=r.attr("action"),j=r.attr("method"),m=r.find("input, select, textarea"),i=r.find(".form-actions"),l=this.$dynamicArea.find(".page-composer__container__child__name"),h,q,k;a(r);d(document).scrollTo(n,200);o.show();m.each(function(){var t=d(this),u=t.attr("name");if(p.isFormControlTypeByName(u,"name")){h=t;l.find(".page-composer__container__child__name__input").bind("propertychange keyup input paste",function(v){h.val(d(this).val())})}else{if(p.isFormControlTypeByName(u,"parent")){q=t;q.val(e.containerId);q.parent().parent().hide()}else{if(p.isFormControlTypeByName(u,"position")){k=t;k.val(f.find("> *").length);k.closest(".form-group").hide()}}}});i.each(function(){var u=d(this),t=d('<span class="btn btn-warning">'+p.translate("cancel")+"</span>");t.on("click",function(v){v.preventDefault();n.remove();d(document).scrollTo(p.$dynamicArea,200)});u.append(t)});r.on("submit",function(u){u.preventDefault();var t=h.val();if(t===""){t=e.blockType}d.ajax({url:s+"&"+d.param({composer:1}),data:r.serialize(),type:j,success:function(x){if(x.result&&x.result==="ok"&&x.objectId){var v=d.Event("blockcreated");v.$childBlock=n;v.parentId=e.containerId;v.blockId=x.objectId;v.blockName=t;v.blockType=e.blockType;d(p).trigger(v)}else{var w=d.Event("blockcreateformloaded");w.response=x;w.containerId=e.containerId;w.blockType=e.blockType;w.container=n;d(p).trigger(w);a(g)}}});return false})},toggleChildBlock:function(g){var h="page-composer__container__child--expanded",e=this.$dynamicArea.find(".page-composer__container__child"),i=g.find(".page-composer__container__child__name"),f=i.find(".page-composer__container__child__name__input");if(g.hasClass(h)){g.removeClass(h);if(i.has(".page-composer__container__child__name__input")){i.html(f.val())}}else{e.not(g).removeClass(h);g.addClass(h)}},handleBlockEditFormLoaded:function(f){var n=this,l=f.$block.find(".page-composer__container__child__edit h4"),m=f.$block.find(".page-composer__container__child__content"),i=f.$block.find(".page-composer__container__child__loader"),o=m.find("form"),g=o.attr("action"),e=o.attr("method"),h=f.$block.find(".page-composer__container__child__edit small").text().trim(),j,k;o.find("input").each(function(){var p=d(this),q=p.attr("name");if(n.isFormControlTypeByName(q,"name")){j=p;l.html('<input type="text" class="page-composer__container__child__name__input" value="'+l.text()+'">');$input=l.find("input");$input.bind("propertychange keyup input paste",function(r){j.val($input.val())});$input.on("click",function(r){r.stopPropagation();r.preventDefault()})}else{if(n.isFormControlTypeByName(q,"position")){k=p;k.closest(".form-group").hide()}}});o.on("submit",function(p){p.preventDefault();i.show();d.ajax({url:g,data:o.serialize(),type:e,success:function(r){i.hide();if(r.result&&r.result==="ok"){if(typeof j!="undefined"){l.text(j.val()!==""?j.val():h)}f.$block.removeClass("page-composer__container__child--expanded");m.empty()}else{m.html(r);var q=d.Event("blockeditformloaded");q.$block=f.$block;d(n).trigger(q);a(m)}}});return false})},controlChildBlock:function(j){var l=this,o=j.find(".page-composer__container__child__content"),m=j.find(".page-composer__container__child__loader"),t=j.find(".page-composer__container__child__edit"),h=t.attr("href"),g=j.find(".page-composer__container__child__remove"),p=g.find("a"),e=j.find(".page-composer__container__child__switch-enabled"),u=e.attr("data-label-enable"),k=e.attr("data-label-disable"),q=e.find("a"),v=q.find("i"),f=j.find(".page-composer__container__child__enabled"),n=f.find("small"),r=f.find("i"),s=q.attr("href"),i=parseInt(j.attr("data-block-enabled"),2);t.click(function(w){w.preventDefault();if(o.find("form").length>0){l.toggleChildBlock(j);return}m.show();d.ajax({url:h,success:function(y){o.html(y);var x=d.Event("blockeditformloaded");x.$block=j;d(l).trigger(x);a(o);m.hide();l.toggleChildBlock(j)}})});q.on("click",function(w){w.preventDefault();d.ajax({url:s,type:"POST",data:{_sonata_csrf_token:l.csrfTokens.switchEnabled,value:!i},success:function(z){j.attr("data-block-enabled",i?"0":"1");i=!i;q.toggleClass("bg-yellow bg-green");v.toggleClass("fa-toggle-off fa-toggle-on");if(i){q.html(k)}else{q.html(u)}n.toggleClass("bg-yellow bg-green");r.toggleClass("fa-times fa-check");if(j.has("form")){var x=j.find("form"),y=x.find("input");y.each(function(){var A=d(this),B=A.attr("name");if(l.isFormControlTypeByName(B,"enabled")){A.val(parseInt(!i))}})}},error:function(){l.containerNotification("composer_status_error","error",true)}})});p.on("click",function(w){w.preventDefault();l.confirmRemoveContainer(j)})},confirmRemoveContainer:function(h){var e=this,g=h.find(".page-composer__container__child__remove"),k=g.find("a"),j=h.find(".page-composer__container__child__remove__dialog"),f=k.attr("href"),l=parseInt(h.attr("data-parent-block-id"),10);if(j.length==0){j=d(['<div class="modal fade page-composer__container__child__remove__dialog" tabindex="-1" role="dialog">','<div class="modal-dialog" role="document">','<div class="modal-content">','<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>','<h4 class="modal-title">'+this.translate("composer_remove_confirm")+"</h4>","</div>",'<div class="modal-body">',"</div>",'<div class="modal-footer">','<button type="button" class="btn btn-default" data-dismiss="modal">'+this.translate("cancel")+"</button>",'<button type="button" class="btn btn-primary">'+this.translate("yes")+"</button>","</div>","</div>","</div>","</div>"].join(""));h.append(j)}var i=j.find(".btn-primary");i.on("click",function(m){d.ajax({url:f,type:"POST",data:{_method:"DELETE",_sonata_csrf_token:e.csrfTokens.remove},success:function(o){if(o.result&&o.result==="ok"){h.remove();var n=d.Event("blockremoved");n.parentId=l;d(e).trigger(n)}}});j.modal("hide");if(d(".modal-backdrop").length!=0){d(".modal-backdrop").hide()}});j.modal("show")},handleContainerLoaded:function(f){var l=this,h=this.$dynamicArea.find(".page-composer__container__children"),k=this.$dynamicArea.find(".page-composer__container__child"),e=this.$dynamicArea.find(".page-composer__block-type-selector"),i=e.find(".page-composer__block-type-selector__loader"),m=e.find("select"),g=e.find(".page-composer__block-type-selector__confirm"),j=g.attr("href");a(this.$dynamicArea);g.on("click",function(p){p.preventDefault();i.css("display","inline-block");var n=m.val(),o=m.find("option:selected").text();d.ajax({url:j,data:{type:n},success:function(q){i.hide();d(l).trigger(d.Event("blockcreateformloaded",{response:q,containerId:f.containerId,blockType:n,blockTypeLabel:o}))}})});h.sortable({revert:true,cursor:"move",revertDuration:200,delay:200,helper:function(r,p){var n=d(p),o=n.find(".page-composer__container__child__edit h4").text().trim(),q=n.find(".page-composer__container__child__edit small").text().trim();n.removeClass("page-composer__container__child--expanded");return d('<div class="page-composer__container__child__helper"><h4>'+o+"</h4></div>")},update:function(o,q){var p=[];h.find(".page-composer__container__child").each(function(r){var s=d(this),u=s.attr("data-parent-block-id"),t=s.attr("data-block-id");if(typeof t!="undefined"){p.push({id:parseInt(t,10),position:r,parent_id:parseInt(u,10),page_id:l.pageId})}});if(p.length>0){var n=d.Event("blockpositionsupdate");n.disposition=p;d(l).trigger(n)}}});k.each(function(){l.controlChildBlock(d(this))})},bindPagePreviewHandlers:function(){var e=this;this.$containerPreviews.each(function(){var f=d(this);f.on("click",function(h){h.preventDefault();var g=d.Event("containerclick");g.$container=f;d(e).trigger(g)})}).droppable({hoverClass:"hover",tolerance:"pointer",revert:true,connectToSortable:".page-composer__container__children",accept:function(f){var h=d(this).attr("data-block-whitelist");if(h===""){return true}h=h.split(",");var g=d(f).attr("data-block-type");return h.indexOf(g)!==-1},drop:function(h,i){var g=i.draggable.attr("data-block-id");if(typeof g!="undefined"){i.helper.remove();var j=d(this),k=parseInt(i.draggable.attr("data-parent-block-id"),10),f=parseInt(j.attr("data-block-id"),10);g=parseInt(g,10);if(k!==f){j.addClass("dropped");j.on("webkitAnimationEnd oanimationend msAnimationEnd animationend",function(l){j.removeClass("dropped")});d.ajax({url:e.getRouteUrl("block_switch_parent"),data:{block_id:g,parent_id:f},success:function(m){if(m.result&&m.result==="ok"){i.draggable.remove();var l=d.Event("blockparentswitched");l.previousParentId=k;l.newParentId=f;l.blockId=g;d(e).trigger(l)}}})}}}});if(this.$containerPreviews.length>0){this.loadContainer(this.$containerPreviews.eq(0))}},bindOrphansHandlers:function(){var e=this;this.$container.find(".page-composer__orphan-container").each(function(){var f=d(this);f.on("click",function(h){h.preventDefault();var g=d.Event("containerclick");g.$container=f;d(e).trigger(g)})})},loadContainer:function(h){var g=h.attr("href"),e=h.attr("data-block-id"),f=this;this.$dynamicArea.empty();this.$containerPreviews.removeClass("active");this.$container.find(".page-composer__orphan-container").removeClass("active");h.addClass("active");d.ajax({url:g,success:function(j){f.$dynamicArea.html(j);d(document).scrollTo(f.$dynamicArea,200,{offset:{top:-100}});var i=d.Event("containerloaded");i.containerId=e;d(f).trigger(i)}})}};c.PageComposer=b;d(function(){d("[data-page-composer]").each(function(){var e=d(this).data("page-composer");new b(e.pageId,e)})})})(jQuery,window);(function(f,d,a,h){var e="treeView",b=".js-treeview",g={togglersAttribute:"[data-treeview-toggler]",toggledState:"is-toggled"};function c(j,i){this.element=j;this.options=f.extend({},g,i);this._defaults=g;this._name=e;this.init()}c.prototype={init:function(){this.setElements();this.setEvents()},setElements:function(){this.$element=f(this.element);this.$togglers=this.$element.find(this.options.togglersAttribute)},setEvents:function(){this.$togglers.on("click",f.proxy(this.toggle,this))},toggle:function(j){var i=f(j.currentTarget),k=i.parent();k.toggleClass(this.options.toggledState);k.next("ul").slideToggle()}};f.fn[e]=function(i){return this.each(function(){if(!f.data(this,"plugin_"+e)){f.data(this,"plugin_"+e,new c(this,i))}})};f(function(){f(b)[e]()})})(jQuery,window,document);