var Admin={collectionCounters:[],shared_setup:function(a){Admin.log("[core|shared_setup] Register services on",a);Admin.set_object_field_value(a);Admin.add_filters(a);Admin.setup_select2(a);Admin.setup_icheck(a);Admin.setup_checkbox_range_selection(a);Admin.setup_xeditable(a);Admin.setup_form_tabs_for_errors(a);Admin.setup_inline_form_errors(a);Admin.setup_tree_view(a);Admin.setup_collection_counter(a);Admin.setup_sticky_elements(a);Admin.setup_readmore_elements(a)},setup_list_modal:function(a){Admin.log("[core|setup_list_modal] configure modal on",a);jQuery("div.modal-dialog",a).css({width:"90%",height:"85%",padding:0});jQuery("div.modal-content",a).css({"border-radius":"0",height:"100%",padding:0});jQuery(".modal-body",a).css({width:"auto",height:"90%",padding:15,overflow:"auto"});jQuery(a).trigger("sonata-admin-setup-list-modal")},setup_select2:function(a){if(window.SONATA_CONFIG&&window.SONATA_CONFIG.USE_SELECT2){Admin.log("[core|setup_select2] configure Select2 on",a);jQuery('select:not([data-sonata-select2="false"])',a).each(function(){var b=jQuery(this);var c=false;var d=b.data("popover");b.removeClass("form-control");if(b.find('option[value=""]').length||b.attr("data-sonata-select2-allow-clear")==="true"){c=true}else{if(b.attr("data-sonata-select2-allow-clear")==="false"){c=false}}b.select2({width:function(){return Admin.get_select2_width(window.Select2?this.element:b)},dropdownAutoWidth:true,minimumResultsForSearch:10,allowClear:c});if(undefined!==d){b.select2("container").popover(d.options)}})}},setup_icheck:function(a){if(window.SONATA_CONFIG&&window.SONATA_CONFIG.USE_ICHECK){Admin.log("[core|setup_icheck] configure iCheck on",a);jQuery("input[type='checkbox']:not('label.btn>input'), input[type='radio']:not('label.btn>input')",a).iCheck({checkboxClass:"icheckbox_square-blue",radioClass:"iradio_square-blue"})}},setup_checkbox_range_selection:function(a){Admin.log("[core|setup_checkbox_range_selection] configure checkbox range selection on",a);var b,c=window.SONATA_CONFIG&&window.SONATA_CONFIG.USE_ICHECK;jQuery('tbody input[type="checkbox"], tbody .iCheck-helper',a).click(function(f){var e;if(c){e=jQuery(this).prev('input[type="checkbox"]')}else{e=jQuery(this)}if(e.length){var d=e.closest("tr").index();if(f.shiftKey&&b>=0){var g=jQuery('tbody input[type="checkbox"]:nth('+d+")",a).prop("checked");jQuery('tbody input[type="checkbox"]',a).each(function(h,j){if(h>b&&h<d||h>d&&h<b){if(c){jQuery(j).iCheck(g?"check":"uncheck");return}jQuery(j).prop("checked",g)}})}b=d}})},setup_xeditable:function(a){Admin.log("[core|setup_xeditable] configure xeditable on",a);jQuery(".x-editable",a).editable({emptyclass:"editable-empty btn btn-sm btn-default",emptytext:'<i class="fa fa-pencil"></i>',container:"body",placement:"auto",success:function(b){var c=jQuery(b);Admin.setup_xeditable(c);jQuery(this).closest("td").replaceWith(c)},error:function(d,c,b){return d.responseText}})},log:function(){var a="[Sonata.Admin] "+Array.prototype.join.call(arguments,", ");if(window.console&&window.console.log){window.console.log(a)}else{if(window.opera&&window.opera.postError){window.opera.postError(a)}}},add_pretty_errors:function(){console.warn("Admin.add_pretty_errors() was deprecated in version 3.0")},stopEvent:function(a){a.preventDefault();return a.target},add_filters:function(a){Admin.log("[core|add_filters] configure filters on",a);jQuery("a.sonata-toggle-filter",a).on("click",function(f){f.preventDefault();f.stopPropagation();if(jQuery(f.target).attr("sonata-filter")=="false"){return}Admin.log("[core|add_filters] handle filter container: ",jQuery(f.target).attr("filter-container"));var g=jQuery("#"+jQuery(f.currentTarget).attr("filter-container"));if(jQuery('div[sonata-filter="true"]:visible',g).length==0){jQuery(g).slideDown()}var c=jQuery(f.currentTarget).attr("filter-target"),d=jQuery('div[id="'+c+'"]',g),b=jQuery("i",'.sonata-toggle-filter[filter-target="'+c+'"]');if(jQuery(d).is(":visible")){b.removeClass("fa-check-square-o").addClass("fa-square-o");d.hide()}else{b.removeClass("fa-square-o").addClass("fa-check-square-o");d.show()}if(jQuery('div[sonata-filter="true"]:visible',g).length>0){jQuery(g).slideDown()}else{jQuery(g).slideUp()}});jQuery(".sonata-filter-form",a).on("submit",function(){jQuery(this).find('[sonata-filter="true"]:hidden :input').val("")});if(jQuery(".advanced-filter :input:visible",a).filter(function(){return jQuery(this).val()}).length===0){jQuery(".advanced-filter").hide()}jQuery('[data-toggle="advanced-filter"]',a).click(function(){jQuery(".advanced-filter").toggle()})},set_object_field_value:function(a){Admin.log("[core|set_object_field_value] set value field on",a);this.log(jQuery("a.sonata-ba-edit-inline",a));jQuery("a.sonata-ba-edit-inline",a).click(function(c){Admin.stopEvent(c);var b=jQuery(this);jQuery.ajax({url:b.attr("href"),type:"POST",success:function(d){var e=jQuery(b).parent();e.children().remove();e.html(jQuery(d.replace(/<!--[\s\S]*?-->/g,"")).html());e.effect("highlight",{color:"#57A957"},2000);Admin.set_object_field_value(e)},error:function(f,e,d){jQuery(b).parent().effect("highlight",{color:"#C43C35"},2000)}})})},setup_collection_counter:function(b){Admin.log("[core|setup_collection_counter] setup collection counter",b);var a=new RegExp("_([0-9]+)[^0-9]*$");jQuery(b).find("[data-prototype]").each(function(){var d=jQuery(this);var c=0;d.children().each(function(){var e=a.exec(jQuery('[id^="sonata-ba-field-container"]',this).attr("id"));if(e&&e[1]&&e[1]>c){c=parseInt(e[1],10)}});Admin.collectionCounters[d.attr("id")]=c})},setup_collection_buttons:function(a){jQuery(a).on("click",".sonata-collection-add",function(f){Admin.stopEvent(f);var c=jQuery(this).closest("[data-prototype]");var b=++Admin.collectionCounters[c.attr("id")];var e=c.attr("data-prototype");var i=c.attr("data-prototype-name")||"__name__";var d=new RegExp(c.attr("id")+"_"+i,"g");e=e.replace(d,c.attr("id")+"_"+b);var g=c.attr("id").split("_");var h=new RegExp(g[g.length-1]+"\\]\\["+i,"g");e=e.replace(h,g[g.length-1]+"]["+b);jQuery(e).insertBefore(jQuery(this).parent()).trigger("sonata-admin-append-form-element");jQuery(this).trigger("sonata-collection-item-added")});jQuery(a).on("click",".sonata-collection-delete",function(b){Admin.stopEvent(b);jQuery(this).trigger("sonata-collection-item-deleted");jQuery(this).closest(".sonata-collection-row").remove();jQuery(document).trigger("sonata-collection-item-deleted-successful")})},setup_per_page_switcher:function(a){Admin.log("[core|setup_per_page_switcher] setup page switcher",a);jQuery("select.per-page").change(function(b){jQuery("input[type=submit]").hide();window.top.location.href=this.options[this.selectedIndex].value})},setup_form_tabs_for_errors:function(a){Admin.log("[core|setup_form_tabs_for_errors] setup form tab's errors",a);jQuery("form",a).each(function(){Admin.show_form_first_tab_with_errors(jQuery(this),".sonata-ba-field-error")});jQuery(a).on("click",'form [type="submit"]',function(){Admin.show_form_first_tab_with_errors(jQuery(this).closest("form"),":invalid")}).on("keypress",'form [type="text"]',function(b){if(13===b.which){Admin.show_form_first_tab_with_errors(jQuery(this),":invalid")}})},show_form_first_tab_with_errors:function(d,b){Admin.log("[core|show_form_first_tab_with_errors] show first tab with errors",d);var c=d.find(".nav-tabs a"),a;c.each(function(){var g=jQuery(this).attr("href"),f=jQuery(this),e=f.find(".has-errors");if(jQuery(g).find(b).length>0){if(!a){f.tab("show");a=f}e.removeClass("hide")}else{e.addClass("hide")}})},setup_inline_form_errors:function(a){Admin.log("[core|setup_inline_form_errors] show first tab with errors",a);var b='.sonata-ba-field-inline-table [id$="_delete"][type="checkbox"]';jQuery(b,a).each(function(){Admin.switch_inline_form_errors(jQuery(this))});jQuery(a).on("change",b,function(){Admin.switch_inline_form_errors(jQuery(this))})},switch_inline_form_errors:function(a){Admin.log("[core|switch_inline_form_errors] switch_inline_form_errors",a);var b=a.closest(".sonata-ba-field-inline-table"),c=b.find(".sonata-ba-field-error-messages");if(a.is(":checked")){b.find("[required]").removeAttr("required").attr("data-required","required");c.hide()}else{b.find("[data-required]").attr("required","required");c.show()}},setup_tree_view:function(a){Admin.log("[core|setup_tree_view] setup tree view",a);jQuery("ul.js-treeview",a).treeView()},get_select2_width:function(d){var g=/width:(auto|(([-+]?([0-9]*\.)?[0-9]+)(px|em|ex|%|in|cm|mm|pt|pc)))/i;var e=d.attr("style");if(e!==undefined){var b=e.split(";");for(var c=0,a=b.length;c<a;c=c+1){var f=b[c].replace(/\s/g,"").match(g);if(f!==null&&f.length>=1){return f[1]}}}e=d.css("width");if(e.indexOf("%")>0){return e}return"100%"},setup_sortable_select2:function(c,d){var a=[];for(var b=0;b<d.length;b++){a[b]={id:d[b].data,text:d[b].label}}c.select2({width:function(){return Admin.get_select2_width(window.Select2?this.element:c)},dropdownAutoWidth:true,data:a,multiple:true});c.select2("container").find("ul.select2-choices").sortable({containment:"parent",start:function(){c.select2("onSortStart")},update:function(){c.select2("onSortEnd")}});c.parents("form:first").submit(function(h){var e=c.val().trim();if(e!==""){var g=c.attr("name");e=e.split(",");g=g.substring(0,g.length-1);for(var f=0;f<e.length;f++){jQuery("<input>").attr("type","hidden").attr("name",g+f+"]").val(e[f]).appendTo(c.parents("form:first"))}}c.remove()})},setup_sticky_elements:function(b){if(window.SONATA_CONFIG&&window.SONATA_CONFIG.USE_STICKYFORMS){Admin.log("[core|setup_sticky_elements] setup sticky elements on",b);var a=jQuery(b).find(".navbar-static-top");var e=jQuery(b).find(".content-wrapper");var c=jQuery(e).find("nav.navbar");var d=jQuery(e).find(".sonata-ba-form-actions");if(c.length){new Waypoint.Sticky({element:c[0],offset:function(){Admin.refreshNavbarStuckClass(a);return jQuery(a).outerHeight()},handler:function(f){if(f=="up"){jQuery(c).width("auto")}else{jQuery(c).width(jQuery(e).outerWidth())}Admin.refreshNavbarStuckClass(a)}})}if(d.length){new Waypoint({element:e[0],offset:"bottom-in-view",handler:function(g){var f=jQuery(".sonata-ba-form form > .row").outerHeight()+jQuery(d).outerHeight()-2;if(f<jQuery(d).offset().top){jQuery(d).removeClass("stuck")}if(g=="up"){jQuery(d).addClass("stuck")}}})}Admin.handleScroll(d,c,e)}},handleScroll:function(c,a,b){if(c.length&&jQuery(window).scrollTop()+jQuery(window).height()!=jQuery(document).height()){jQuery(c).addClass("stuck")}jQuery(window).scroll(Admin.debounce(function(){if(c.length&&jQuery(window).scrollTop()+jQuery(window).height()==jQuery(document).height()){jQuery(c).removeClass("stuck")}if(a.length&&jQuery(window).scrollTop()===0){jQuery(a).removeClass("stuck")}},250));jQuery("body").on("expanded.pushMenu collapsed.pushMenu",function(){setTimeout(function(){Admin.handleResize(c,a,b)},350)});jQuery(window).resize(Admin.debounce(function(){Admin.handleResize(c,a,b)},250))},handleResize:function(c,a,b){if(a.length&&jQuery(a).hasClass("stuck")){jQuery(a).width(jQuery(b).outerWidth())}if(c.length&&jQuery(c).hasClass("stuck")){jQuery(c).width(jQuery(b).outerWidth())}},refreshNavbarStuckClass:function(a){var b=jQuery("#navbar-stuck");if(!b.length){b=jQuery('<style id="navbar-stuck">').prop("type","text/css").appendTo("head")}b.html("body.fixed .content-header .navbar.stuck { top: "+jQuery(a).outerHeight()+"px; }")},debounce:function(b,d,a){var c;return function(){var h=this,g=arguments;var f=function(){c=null;if(!a){b.apply(h,g)}};var e=a&&!c;clearTimeout(c);c=setTimeout(f,d);if(e){b.apply(h,g)}}},setup_readmore_elements:function(a){Admin.log("[core|setup_readmore_elements] setup readmore elements on",a);jQuery(a).find(".sonata-readmore").each(function(b,c){jQuery(this).readmore({collapsedHeight:parseInt(jQuery(this).data("readmore-height")),moreLink:'<a href="#">'+jQuery(this).data("readmore-more")+"</a>",lessLink:'<a href="#">'+jQuery(this).data("readmore-less")+"</a>"})})},handle_top_navbar_height:function(){jQuery(".content-wrapper").css("padding-top",jQuery(".navbar-static-top").outerHeight())}};jQuery(document).ready(function(){Admin.handle_top_navbar_height()});jQuery(window).resize(function(){Admin.handle_top_navbar_height()});jQuery(document).ready(function(){jQuery("html").removeClass("no-js");if(window.SONATA_CONFIG&&window.SONATA_CONFIG.CONFIRM_EXIT){jQuery(".sonata-ba-form form").each(function(){jQuery(this).confirmExit()})}Admin.setup_per_page_switcher(document);Admin.setup_collection_buttons(document);Admin.shared_setup(document)});jQuery(document).on("sonata-admin-append-form-element",function(a){Admin.setup_select2(a.target);Admin.setup_icheck(a.target);Admin.setup_collection_counter(a.target)});